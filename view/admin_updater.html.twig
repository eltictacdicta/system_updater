{#
/**
 * This file is part of system_updater plugin for FSFramework
 * Vista del Actualizador del Sistema
 */
#}
{{ include('header.html.twig') }}

<div class="container-fluid" style="margin-top: 10px;">
    <div class="row">
        <div class="col-xs-6">
            <div class="btn-group">
                <a class="btn btn-sm btn-default" href="{{ fsc.url()|raw }}" title="Recargar la página">
                    <span class="glyphicon glyphicon-refresh"></span>
                </a>
            </div>
        </div>
        <div class="col-xs-6 text-right">
            <h2 style="margin-top: 0px;">
                <i class="fa fa-sync-alt"></i> Actualizador del Sistema
            </h2>
        </div>
    </div>
</div>

{# Mensajes #}
{% if fsc.successMessage %}
<div class="alert alert-success alert-dismissible" style="margin: 10px;">
    <button type="button" class="close" data-dismiss="alert">&times;</button>
    <i class="fa fa-check-circle"></i> {{ fsc.successMessage }}
</div>
{% endif %}

{% if fsc.errorMessage %}
<div class="alert alert-danger alert-dismissible" style="margin: 10px;">
    <button type="button" class="close" data-dismiss="alert">&times;</button>
    <i class="fa fa-exclamation-circle"></i> {{ fsc.errorMessage }}
</div>
{% endif %}

<div class="row" style="margin: 10px;">
    {# Panel de Actualizaciones #}
    <div class="col-md-6">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-download"></i> Actualizaciones Disponibles</h3>
            </div>
            <div class="panel-body">
                {# Actualización del Núcleo #}
                {% if fsc.updates.core %}
                <div class="alert alert-warning">
                    <strong><i class="fa fa-cube"></i> Nueva versión del núcleo disponible</strong>
                    <p>Versión actual: {{ fsc.plugin_manager.version }}<br>
                    Nueva versión: {{ fsc.updates.core_new_version }}</p>
                    <a href="{{ fsc.url()|raw }}&action=update_core" class="btn btn-warning btn-sm" onclick="return confirm('¿Crear backup y actualizar el núcleo?');">
                        <i class="fa fa-sync"></i> Actualizar Núcleo
                    </a>
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="fa fa-check"></i> El núcleo está actualizado (v{{ fsc.plugin_manager.version }})
                </div>
                {% endif %}

                {# Actualizaciones de Plugins #}
                {% if fsc.updates.plugins|length > 0 %}
                <h5><i class="fa fa-puzzle-piece"></i> Plugins con actualizaciones:</h5>
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Plugin</th>
                            <th>Actual</th>
                            <th>Nueva</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plugin in fsc.updates.plugins %}
                        <tr>
                            <td>{{ plugin.name }}</td>
                            <td>{{ plugin.current_version }}</td>
                            <td><span class="label label-info">{{ plugin.new_version }}</span></td>
                            <td>
                                <a href="{{ fsc.url()|raw }}&action=update_plugin&plugin={{ plugin.name }}" class="btn btn-xs btn-primary" onclick="return confirm('¿Actualizar {{ plugin.name }}?');">
                                    <i class="fa fa-sync"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted"><i class="fa fa-check"></i> Todos los plugins están actualizados.</p>
                {% endif %}
            </div>
        </div>
    </div>

    {# Panel de Backups #}
    <div class="col-md-6">
        <div class="panel panel-success">
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-database"></i> Copias de Seguridad</h3>
            </div>
            <div class="panel-body">
                <p>
                    <button type="button" class="btn btn-success" id="btn-create-backup">
                        <i class="fa fa-plus"></i> Crear Backup Completo
                    </button>
                    <span id="backup-loading" style="display:none; margin-left: 10px;">
                        <i class="fa fa-spinner fa-spin"></i> Procesando...
                    </span>
                </p>

                <div id="backups-container">
                    {% if fsc.backups|length > 0 %}
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in fsc.backups %}
                            <tr>
                                <td>
                                    <strong>{{ group.base_name }}</strong>
                                    <br><small class="text-muted">
                                        {% if group.complete %}
                                            <span class="label label-primary" title="{{ group.complete.size_formatted }}">Completo ({{ group.complete.size_formatted }})</span>
                                        {% endif %}
                                        {% if group.files %}
                                            <span class="label label-info" title="{{ group.files.size_formatted }}">Archivos ({{ group.files.size_formatted }})</span>
                                        {% endif %}
                                        {% if group.database %}
                                            <span class="label label-warning" title="{{ group.database.size_formatted }}">BD ({{ group.database.size_formatted }})</span>
                                        {% endif %}
                                    </small>
                                </td>
                                <td>{{ group.date|date('d/m/Y H:i') }}</td>
                                <td>
                                    <div class="btn-group btn-group-xs">
                                        {% if group.complete %}
                                        <div class="btn-group btn-group-xs">
                                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                                                <i class="fa fa-download"></i> <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu pull-right">
                                                <li><a href="{{ fsc.url()|raw }}&action=download_backup&file={{ group.complete.name }}" target="_blank">Descargar Completo</a></li>
                                                {% if group.files %}<li><a href="{{ fsc.url()|raw }}&action=download_backup&file={{ group.files.name }}" target="_blank">Descargar Archivos</a></li>{% endif %}
                                                {% if group.database %}<li><a href="{{ fsc.url()|raw }}&action=download_backup&file={{ group.database.name }}" target="_blank">Descargar BD</a></li>{% endif %}
                                            </ul>
                                        </div>
                                        <button type="button" class="btn btn-warning btn-restore" data-action="restore_complete" data-file="{{ group.complete.name }}" title="Restaurar todo">
                                            <i class="fa fa-undo"></i>
                                        </button>
                                        {% endif %}
                                        
                                        {% if not group.complete %}
                                            {% if group.files %}
                                            <a href="{{ fsc.url()|raw }}&action=download_backup&file={{ group.files.name }}" class="btn btn-default" title="Descargar Archivos" target="_blank">
                                                <i class="fa fa-download"></i>
                                            </a>
                                            <button type="button" class="btn btn-default btn-restore" data-action="restore_files" data-file="{{ group.files.name }}" title="Restaurar Archivos">
                                                <i class="fa fa-folder"></i>
                                            </button>
                                            {% endif %}
                                            {% if group.database %}
                                            <a href="{{ fsc.url()|raw }}&action=download_backup&file={{ group.database.name }}" class="btn btn-default" title="Descargar BD" target="_blank">
                                                <i class="fa fa-database"></i>
                                            </a>
                                            <button type="button" class="btn btn-default btn-restore" data-action="restore_database" data-file="{{ group.database.name }}" title="Restaurar BD">
                                                <i class="fa fa-database"></i>
                                            </button>
                                            {% endif %}
                                        {% endif %}

                                        <button type="button" class="btn btn-danger btn-delete" data-base="{{ group.base_name }}" title="Eliminar">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">No hay copias de seguridad.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
$(document).ready(function() {
    function showLoading() {
        $('#backup-loading').show();
        $('button').prop('disabled', true);
    }

    function hideLoading() {
        $('#backup-loading').hide();
        $('button').prop('disabled', false);
    }

    // Crear Backup
    $('#btn-create-backup').click(function(e) {
        e.preventDefault();
        if(confirm('¿Crear copia de seguridad completa?')) {
            showLoading();
            $.ajax({
                url: '{{ fsc.url()|raw }}&action=create_backup&ajax=1',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if(response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert(response.message);
                        hideLoading();
                    }
                },
                error: function() {
                    alert('Error de conexión');
                    hideLoading();
                }
            });
        }
    });

    // Restaurar
    $('.btn-restore').click(function(e) {
        e.preventDefault();
        var action = $(this).data('action');
        var file = $(this).data('file');
        var msg = '¿Está seguro de querer restaurar esta copia?';
        
        if(action == 'restore_complete') msg = '¿Restaurar sistema COMPLETO? Esto sobrescribirá archivos y base de datos.';
        
        if(confirm(msg)) {
            showLoading();
            $.ajax({
                url: '{{ fsc.url()|raw }}&action=' + action + '&file=' + file + '&ajax=1',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if(response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert(response.message);
                        hideLoading();
                    }
                },
                error: function() {
                    alert('Error de conexión');
                    hideLoading();
                }
            });
        }
    });

    // Eliminar
    $('.btn-delete').click(function(e) {
        e.preventDefault();
        var baseName = $(this).data('base');
        
        if(confirm('¿Eliminar este grupo de copias de seguridad?')) {
            showLoading();
            $.ajax({
                url: '{{ fsc.url()|raw }}&action=delete_backup_group&base_name=' + baseName + '&ajax=1',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if(response.success) {
                        location.reload();
                    } else {
                        alert(response.message);
                        hideLoading();
                    }
                },
                error: function() {
                    alert('Error de conexión');
                    hideLoading();
                }
            });
        }
    });
});
</script>

{# Información del Sistema #}
<div class="row" style="margin: 10px;">
    <div class="col-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-info-circle"></i> Información del Sistema</h3>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Versión FSFramework:</strong> {{ fsc.plugin_manager.version }}
                    </div>
                    <div class="col-md-4">
                        <strong>Directorio de Backups:</strong> {{ fsc.getBackupPath() }}
                    </div>
                    <div class="col-md-4">
                        <strong>Plugin Actualizador:</strong> {{ fsc.updaterInfo.version|default('1.0.0') }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{ include('footer.html.twig') }}
